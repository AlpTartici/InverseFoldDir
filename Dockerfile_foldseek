FROM mcr.microsoft.com/mirror/nvcr/nvidia/cuda:12.6.3-cudnn-devel-ubuntu22.04

WORKDIR /workspace

# Install minimal dependencies for Miniconda download
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Miniconda (pinned version for reproducibility)
RUN wget -q https://repo.anaconda.com/miniconda/Miniconda3-py312_24.9.2-0-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    /bin/bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh && \
    /opt/conda/bin/conda clean --all -f -y && \
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc

# Add conda to PATH (initial setup)
ENV PATH="/opt/conda/bin:$PATH"

# Set LD_LIBRARY_PATH early to help with CUDA detection
ENV LD_LIBRARY_PATH="/opt/conda/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

# Setup conda channels (no update needed - fresh install)
RUN conda config --add channels conda-forge && \
    conda config --add channels pytorch && \
    conda config --add channels nvidia

# Install mamba for faster package resolution
RUN conda install -c conda-forge -c bioconda foldseek

COPY datasets/test_val_chain_pdbs /workspace/datasets/test_val_chain_pdbs
COPY datasets/*sh /workspace/datasets/


CMD ["/bin/bash"]
